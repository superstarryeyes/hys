name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2
      
      - name: Install Curl Headers
        run: sudo apt-get update && sudo apt-get install -y libcurl4-openssl-dev
      
      - name: Run Tests
        run: zig build test

  release:
    needs: test
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ steps.version.outputs.VERSION }}
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(steps.version.outputs.VERSION, '-') }}

  homebrew:
    needs: release
    name: Update Homebrew Tap
    runs-on: ubuntu-latest
    steps:
      - name: Check for Homebrew token
        env:
          TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          if [ -z "$TOKEN" ]; then
            echo "::error::HOMEBREW_TAP_TOKEN secret is not set"
            exit 1
          fi

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Trigger Homebrew tap update
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          repository: superstarryeyes/homebrew-tap
          event-type: hys-release
          client-payload: '{"version": "${{ steps.version.outputs.VERSION }}", "tag": "${{ github.ref_name }}"}'
